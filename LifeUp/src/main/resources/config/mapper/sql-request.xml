<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd"> 

<mapper namespace="request">
	
	<insert id="registerRequest" parameterType="salesman.vo.estimate.RequestVO">
		INSERT INTO estimate_request (
			customer_id, region_cd, car_id, car_model, car_option, customer_req, status, purchase_period_cd, hit_cnt, create_date
		) VALUES (
			#{customer_id}, #{region_cd}, #{car_id}, #{car_model}, #{car_option}, #{customer_req}, '0001', #{purchase_period_cd}, 0, now()
		)			
	</insert>

	<select id="getRequestList" resultType="java.util.HashMap" parameterType="Integer">
		SELECT @RNUM:=@RNUM+1 AS ROWNUM
			 , b.*
		  FROM (
				  SELECT @RNUM:=0
				  	   ,a.REQUEST_ID
					   , a.CUSTOMER_ID
					   , (SELECT CUSTOMER_NM FROM CUSTOMER WHERE CUSTOMER_ID = a.CUSTOMER_ID) CUSTOMER_NM
					   , a.REGION_CD
					   , (SELECT CONCAT(SIDO, ' ', GUGUN) FROM REGION WHERE REGION_CD = a.REGION_CD) REGION_NM
					   , c.VENDOR_ID
					   , c.VENDOR_NM					   
					   , a.CAR_ID
					   , b.CAR_NM
					   , a.CAR_MODEL
					   , a.CAR_OPTION
					   , a.CUSTOMER_REQ
					   , a.STATUS
					   , (SELECT CODE_NM FROM CODES WHERE CODE_GROUP = '1001' AND CODE_CD = A.STATUS) STATUS_NM
					   , DATE(a.CREATE_DATE) CREATE_DATE
					   , DATE(a.UPDATE_DATE) UPDATE_DATE
					   , a.PURCHASE_PERIOD_CD
					   , a.HIT_CNT
				    FROM ESTIMATE_REQUEST a
				  	LEFT JOIN CAR_MASTER  b ON a.CAR_ID    = b.CAR_ID
				   INNER JOIN VENDOR      c ON b.VENDOR_ID = c.VENDOR_ID
				   ORDER BY a.CREATE_DATE DESC
			   ) b 
		  limit 0, #{currentSeq};
	</select>
		
	<select id="getRequestListMore" resultType="java.util.HashMap" parameterType="Integer">
		SELECT @RNUM:=@RNUM+1 AS ROWNUM
			 , b.*
		  FROM (
				  SELECT @RNUM:=0
				  	   ,a.REQUEST_ID
					   , a.CUSTOMER_ID
					   , (SELECT CUSTOMER_NM FROM CUSTOMER WHERE CUSTOMER_ID = a.CUSTOMER_ID) CUSTOMER_NM
					   , a.REGION_CD
					   , (SELECT CONCAT(SIDO, ' ', GUGUN) FROM REGION WHERE REGION_CD = a.REGION_CD) REGION_NM
					   , c.VENDOR_ID
					   , c.VENDOR_NM					   
					   , a.CAR_ID
					   , b.CAR_NM
					   , a.CAR_MODEL
					   , a.CAR_OPTION
					   , a.CUSTOMER_REQ
					   , a.STATUS
					   , (SELECT CODE_NM FROM CODES WHERE CODE_GROUP = '1001' AND CODE_CD = A.STATUS) STATUS_NM
					   , DATE(a.CREATE_DATE) CREATE_DATE
					   , DATE(a.UPDATE_DATE) UPDATE_DATE
					   , a.PURCHASE_PERIOD_CD
					   , a.HIT_CNT
				    FROM ESTIMATE_REQUEST a
					LEFT JOIN CAR_MASTER  b ON a.CAR_ID    = b.CAR_ID
				   INNER JOIN VENDOR      c ON b.VENDOR_ID = c.VENDOR_ID
				   ORDER BY a.CREATE_DATE DESC
			   ) b 			   
		  limit #{currentSeq}, 7;
	</select>
	
	<!-- 견적의뢰 상세화면-->
	<select id="getRequestDetail" resultType="java.util.HashMap">
		SELECT A.REQUEST_ID
			 , A.CUSTOMER_ID
			 , (SELECT CUSTOMER_NM FROM CUSTOMER WHERE CUSTOMER_ID = A.CUSTOMER_ID) CUSTOMER_NM
		     , B.REGION_CD
			 , B.SIDO
		     , B.GUGUN
			 , A.CAR_ID
		     , C.CAR_NM
			 , D.VENDOR_ID
		     , D.VENDOR_NM
		     , A.CAR_OPTION
		     , A.CUSTOMER_REQ
			 , A.STATUS
		     , (SELECT CODE_NM FROM CODES WHERE CODE_GROUP = '1001' AND CODE_CD = A.STATUS) STATUS_NM
			 , DATE(A.CREATE_DATE) CREATE_DATE
			 , A.PURCHASE_PERIOD_CD
			 , a.HIT_CNT
		  FROM ESTIMATE_REQUEST A
		     , REGION B
		     , CAR_MASTER C
		     , VENDOR D
		 WHERE A.REGION_CD  = B.REGION_CD
		   AND A.CAR_ID     = C.CAR_ID
		   AND C.VENDOR_ID  = D.VENDOR_ID 
		   AND A.REQUEST_ID = #{ReqId}
	</select>
	
	<insert id="updateRequestHitCnt">
		UPDATE estimate_request
		   SET HIT_CNT    = HIT_CNT + 1
		 WHERE REQUEST_ID = #{request_id}
	</insert>		
	
	<update id="updateRequestStatus">
		UPDATE estimate_request
		   SET STATUS     = ${status}
		 WHERE REQUEST_ID = #{request_id}
	</update>

</mapper>